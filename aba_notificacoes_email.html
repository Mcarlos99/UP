<!-- ADICIONE ESTA ABA NO SEU ARQUIVO configuracoes.php -->

<!-- PASSO 1: Adicione este botão de aba junto com os outros (linha ~589) -->
<button id="tab-email" onclick="mostrarTab('email')" 
        class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 px-4 py-3 border-b-2 font-medium text-base transition-colors whitespace-nowrap">
    <i class="fas fa-envelope"></i> <span class="hidden md:inline">Notificações Email</span>
</button>

<!-- PASSO 2: Adicione este conteúdo da aba logo após as outras tabs (linha ~1100) -->
<!-- Tab: Notificações por Email -->
<div id="content-email" class="tab-content hidden">
    <div class="white-card p-3 md:p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg md:text-2xl font-bold text-gray-900">
                <i class="fas fa-envelope text-purple-600"></i> Configurações de Email
            </h3>
        </div>

        <?php
        // Buscar ou criar configuração de email
        try {
            $stmt = $db->prepare("SELECT * FROM configuracoes_empresa WHERE empresa_id = ?");
            $stmt->execute([$empresaId]);
            $configEmail = $stmt->fetch();
            
            if (!$configEmail) {
                // Criar configuração padrão
                $stmt = $db->prepare("
                    INSERT INTO configuracoes_empresa 
                    (empresa_id, email_notificacao, nome_empresa, enviar_email_pedido, mensagem_email_pedido) 
                    VALUES (?, ?, ?, 1, ?)
                ");
                $stmt->execute([
                    $empresaId,
                    $_SESSION['user_email'] ?? 'contato@empresa.com',
                    $_SESSION['user_nome'] ?? 'Empresa',
                    'Você recebeu um novo pedido! Acesse o sistema para visualizar os detalhes.'
                ]);
                
                $stmt = $db->prepare("SELECT * FROM configuracoes_empresa WHERE empresa_id = ?");
                $stmt->execute([$empresaId]);
                $configEmail = $stmt->fetch();
            }
        } catch (PDOException $e) {
            $configEmail = null;
            $erro = "Erro ao carregar configurações de email";
        }
        ?>

        <form method="POST" action="" enctype="multipart/form-data">
            <input type="hidden" name="action" value="salvar_config_email">
            
            <div class="space-y-6">
                <!-- Email de Notificação -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-at text-purple-600"></i> Email para Notificações *
                    </label>
                    <input type="email" name="email_notificacao" required
                           value="<?php echo htmlspecialchars($configEmail['email_notificacao'] ?? ''); ?>"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                           placeholder="seu-email@empresa.com">
                    <p class="text-xs text-gray-500 mt-1">
                        Este email receberá notificações quando novos pedidos forem criados
                    </p>
                </div>

                <!-- Nome da Empresa -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-building text-purple-600"></i> Nome da Empresa
                    </label>
                    <input type="text" name="nome_empresa_email"
                           value="<?php echo htmlspecialchars($configEmail['nome_empresa'] ?? ''); ?>"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                           placeholder="Nome que aparecerá nos emails">
                </div>

                <!-- Telefone -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-phone text-purple-600"></i> Telefone de Contato
                    </label>
                    <input type="text" name="telefone_email"
                           value="<?php echo htmlspecialchars($configEmail['telefone'] ?? ''); ?>"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                           placeholder="(00) 00000-0000"
                           data-mask="telefone">
                </div>

                <!-- Checkbox: Enviar Email -->
                <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" name="enviar_email_pedido" 
                               <?php echo ($configEmail['enviar_email_pedido'] ?? 1) ? 'checked' : ''; ?>
                               class="h-5 w-5 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                        <span class="ml-3 text-sm font-semibold text-gray-900">
                            Enviar email automaticamente quando um novo pedido for criado
                        </span>
                    </label>
                </div>

                <!-- Mensagem Personalizada -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-comment-dots text-purple-600"></i> Mensagem Personalizada do Email
                    </label>
                    <textarea name="mensagem_email_pedido" rows="5"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                              placeholder="Digite a mensagem que aparecerá no email de notificação"
                    ><?php echo htmlspecialchars($configEmail['mensagem_email_pedido'] ?? 'Você recebeu um novo pedido! Acesse o sistema para visualizar os detalhes.'); ?></textarea>
                    <p class="text-xs text-gray-500 mt-1">
                        Esta mensagem aparecerá no início de cada email de notificação de pedido
                    </p>
                </div>

                <!-- Cores de Personalização -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-palette text-purple-600"></i> Cor Primária
                        </label>
                        <div class="flex items-center gap-3">
                            <input type="color" name="cor_primaria"
                                   value="<?php echo htmlspecialchars($configEmail['cor_primaria'] ?? '#4F46E5'); ?>"
                                   class="h-12 w-24 border border-gray-300 rounded cursor-pointer">
                            <span class="text-sm text-gray-600">
                                <?php echo htmlspecialchars($configEmail['cor_primaria'] ?? '#4F46E5'); ?>
                            </span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-palette text-purple-600"></i> Cor Secundária
                        </label>
                        <div class="flex items-center gap-3">
                            <input type="color" name="cor_secundaria"
                                   value="<?php echo htmlspecialchars($configEmail['cor_secundaria'] ?? '#10B981'); ?>"
                                   class="h-12 w-24 border border-gray-300 rounded cursor-pointer">
                            <span class="text-sm text-gray-600">
                                <?php echo htmlspecialchars($configEmail['cor_secundaria'] ?? '#10B981'); ?>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Botão Salvar -->
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="btn btn-primary flex-1">
                        <i class="fas fa-save"></i> Salvar Configurações de Email
                    </button>
                </div>
            </div>
        </form>

        <!-- Seção de Teste -->
        <div class="mt-8 pt-8 border-t border-gray-200">
            <h4 class="text-lg font-bold text-gray-900 mb-4">
                <i class="fas fa-flask text-blue-600"></i> Testar Envio de Email
            </h4>
            
            <form method="POST" action="" class="flex gap-3">
                <input type="hidden" name="action" value="testar_email">
                <div class="flex-1">
                    <input type="email" name="email_teste" required
                           placeholder="Digite um email para teste"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold whitespace-nowrap">
                    <i class="fas fa-paper-plane"></i> Enviar Teste
                </button>
            </form>
            
            <p class="text-xs text-gray-500 mt-2">
                <i class="fas fa-info-circle"></i> Um email de teste será enviado para verificar se está tudo funcionando
            </p>
        </div>

        <!-- Logs Recentes -->
        <div class="mt-8 pt-8 border-t border-gray-200">
            <h4 class="text-lg font-bold text-gray-900 mb-4">
                <i class="fas fa-history text-gray-600"></i> Últimos Emails Enviados
            </h4>
            
            <?php
            try {
                $stmt = $db->prepare("
                    SELECT * FROM logs_email 
                    WHERE empresa_id = ? 
                    ORDER BY data_envio DESC 
                    LIMIT 10
                ");
                $stmt->execute([$empresaId]);
                $logsEmail = $stmt->fetchAll();
            } catch (PDOException $e) {
                $logsEmail = [];
            }
            ?>

            <div class="space-y-2">
                <?php if (empty($logsEmail)): ?>
                    <p class="text-gray-500 text-center py-4 text-sm">Nenhum email enviado ainda</p>
                <?php else: ?>
                    <?php foreach ($logsEmail as $log): ?>
                        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                            <div class="<?php echo $log['sucesso'] ? 'bg-green-100' : 'bg-red-100'; ?> p-2 rounded-lg">
                                <i class="fas <?php echo $log['sucesso'] ? 'fa-check text-green-600' : 'fa-times text-red-600'; ?>"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-semibold text-gray-900">
                                    <?php echo htmlspecialchars($log['assunto'] ?? 'Email'); ?>
                                </p>
                                <p class="text-xs text-gray-600">
                                    Para: <?php echo htmlspecialchars($log['destinatario']); ?> • 
                                    <?php echo formatarData($log['data_envio'], 'd/m/Y H:i'); ?>
                                </p>
                            </div>
                        </div>
                    <?php endforeach; ?>
                <?php endif; ?>
            </div>
        </div>
    </div>
</div>

<!-- PASSO 3: Adicione este código PHP no início do arquivo, junto com os outros IFs de POST (linha ~216) -->
<?php
// Salvar configurações de email
if (isset($_POST['action']) && $_POST['action'] === 'salvar_config_email') {
    try {
        $email_notificacao = sanitize($_POST['email_notificacao']);
        $nome_empresa_email = sanitize($_POST['nome_empresa_email'] ?? '');
        $telefone_email = sanitize($_POST['telefone_email'] ?? '');
        $enviar_email = isset($_POST['enviar_email_pedido']) ? 1 : 0;
        $mensagem_email = sanitize($_POST['mensagem_email_pedido']);
        $cor_primaria = sanitize($_POST['cor_primaria'] ?? '#4F46E5');
        $cor_secundaria = sanitize($_POST['cor_secundaria'] ?? '#10B981');
        
        if (!validarEmail($email_notificacao)) {
            throw new Exception('Email de notificação inválido');
        }
        
        // Verificar se já existe configuração
        $stmt = $db->prepare("SELECT id FROM configuracoes_empresa WHERE empresa_id = ?");
        $stmt->execute([$empresaId]);
        $existe = $stmt->fetch();
        
        if ($existe) {
            // Atualizar
            $stmt = $db->prepare("
                UPDATE configuracoes_empresa 
                SET email_notificacao = ?,
                    nome_empresa = ?,
                    telefone = ?,
                    enviar_email_pedido = ?,
                    mensagem_email_pedido = ?,
                    cor_primaria = ?,
                    cor_secundaria = ?
                WHERE empresa_id = ?
            ");
            $stmt->execute([
                $email_notificacao,
                $nome_empresa_email,
                $telefone_email,
                $enviar_email,
                $mensagem_email,
                $cor_primaria,
                $cor_secundaria,
                $empresaId
            ]);
        } else {
            // Inserir
            $stmt = $db->prepare("
                INSERT INTO configuracoes_empresa 
                (empresa_id, email_notificacao, nome_empresa, telefone, enviar_email_pedido, mensagem_email_pedido, cor_primaria, cor_secundaria) 
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            ");
            $stmt->execute([
                $empresaId,
                $email_notificacao,
                $nome_empresa_email,
                $telefone_email,
                $enviar_email,
                $mensagem_email,
                $cor_primaria,
                $cor_secundaria
            ]);
        }
        
        logActivity('Configurações de email atualizadas', 'configuracoes_empresa');
        $_SESSION['success'] = 'Configurações de email salvas com sucesso!';
        header('Location: configuracoes.php');
        exit;
        
    } catch (Exception $e) {
        $_SESSION['error'] = 'Erro ao salvar configurações de email: ' . $e->getMessage();
    }
}

// Testar envio de email
if (isset($_POST['action']) && $_POST['action'] === 'testar_email') {
    try {
        $email_teste = sanitize($_POST['email_teste']);
        
        if (!validarEmail($email_teste)) {
            throw new Exception('Email de teste inválido');
        }
        
        // Buscar configurações
        $stmt = $db->prepare("SELECT * FROM configuracoes_empresa WHERE empresa_id = ?");
        $stmt->execute([$empresaId]);
        $config = $stmt->fetch();
        
        if (!$config) {
            throw new Exception('Configure o email de notificação primeiro');
        }
        
        // Montar email
        $assunto = 'Teste de Notificação - ' . ($config['nome_empresa'] ?? 'Sistema');
        $corpo = "Este é um email de teste do sistema PapelOn.\n\n";
        $corpo .= "Se você recebeu este email, significa que as notificações estão funcionando corretamente!\n\n";
        $corpo .= "Empresa: " . ($config['nome_empresa'] ?? 'N/A') . "\n";
        $corpo .= "Email: " . $config['email_notificacao'] . "\n";
        $corpo .= "Data/Hora: " . date('d/m/Y H:i:s') . "\n\n";
        $corpo .= "---\n";
        $corpo .= "Sistema PapelOn Multi-Tenant";
        
        $headers = "From: " . $config['email_notificacao'] . "\r\n";
        $headers .= "Reply-To: " . $config['email_notificacao'] . "\r\n";
        $headers .= "X-Mailer: PHP/" . phpversion();
        
        $sucesso = mail($email_teste, $assunto, $corpo, $headers);
        
        // Registrar log
        $stmt = $db->prepare("
            INSERT INTO logs_email (empresa_id, destinatario, assunto, sucesso, data_envio)
            VALUES (?, ?, ?, ?, NOW())
        ");
        $stmt->execute([$empresaId, $email_teste, $assunto, $sucesso ? 1 : 0]);
        
        if ($sucesso) {
            $_SESSION['success'] = 'Email de teste enviado com sucesso para ' . $email_teste;
        } else {
            throw new Exception('Falha ao enviar email. Verifique a configuração do servidor.');
        }
        
        header('Location: configuracoes.php');
        exit;
        
    } catch (Exception $e) {
        $_SESSION['error'] = 'Erro ao testar email: ' . $e->getMessage();
        header('Location: configuracoes.php');
        exit;
    }
}
?>
